<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ğŸ” Admin Â· LÃ¬ XÃ¬ Control Panel</title>
<meta name="robots" content="noindex,nofollow"/>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;700&family=Noto+Sans:wght@300;400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet"/>
<style>
:root{--bg:#0b0c14;--card:#11121f;--hover:#181929;--border:rgba(255,255,255,.07);--border-gold:rgba(212,160,23,.35);--border-red:rgba(192,57,43,.4);--red:#c0392b;--red2:#e74c3c;--gold:#d4a017;--gold2:#f1c40f;--gold3:#ffd700;--txt:#e8e8f0;--txt2:#8888a0;--txt3:#44445a;--green:#2ecc71;--blue:#3498db;--sw:260px;--hh:64px;--r:14px}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{font-size:15px}body{font-family:'Noto Sans',sans-serif;background:var(--bg);color:var(--txt);min-height:100vh;overflow-x:hidden}

/* â”€â”€ LOGIN â”€â”€ */
#login-screen{position:fixed;inset:0;background:linear-gradient(135deg,#0b0c14,#15162a,#0e0f1c);display:flex;align-items:center;justify-content:center;z-index:9999;transition:opacity .5s,visibility .5s}
#login-screen.hidden{opacity:0;visibility:hidden;pointer-events:none}
.lbox{background:var(--card);border:1px solid var(--border-gold);border-radius:24px;padding:55px 50px;width:min(420px,92vw);text-align:center;box-shadow:0 40px 80px rgba(0,0,0,.7),inset 0 1px 0 rgba(255,255,255,.06);animation:lappear .6s cubic-bezier(.22,1,.36,1) both}
@keyframes lappear{from{opacity:0;transform:translateY(40px) scale(.95)}to{opacity:1;transform:translateY(0) scale(1)}}
.llogo{font-size:3.5rem;margin-bottom:20px;display:block;animation:lpulse 2s ease-in-out infinite}
@keyframes lpulse{0%,100%{filter:drop-shadow(0 0 8px rgba(255,215,0,.4))}50%{filter:drop-shadow(0 0 22px rgba(255,215,0,.9))}}
.ltitle{font-family:'Noto Serif',serif;font-size:1.6rem;color:var(--gold3);margin-bottom:6px}
.lsub{font-size:.8rem;color:var(--txt2);letter-spacing:3px;text-transform:uppercase;margin-bottom:35px}
.lfield{margin-bottom:16px;text-align:left}
.lfield label{display:block;font-size:.75rem;color:var(--txt2);letter-spacing:2px;text-transform:uppercase;margin-bottom:7px}
.lfield input{width:100%;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:13px 16px;color:var(--txt);font-family:'JetBrains Mono',monospace;font-size:.95rem;outline:none;transition:border-color .2s,box-shadow .2s}
.lfield input:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(212,160,23,.12)}
.lfield input::placeholder{color:var(--txt3)}
.lerr{color:var(--red2);font-size:.82rem;margin-bottom:12px;min-height:20px}
.lerr.shake{animation:shake .3s ease}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}
.lbtn{width:100%;background:linear-gradient(135deg,var(--red),var(--red2));color:#fff;border:none;padding:14px;border-radius:10px;font-size:1rem;font-weight:700;cursor:pointer;font-family:'Noto Sans',sans-serif;letter-spacing:1px;transition:all .25s;margin-top:5px;box-shadow:0 4px 20px rgba(192,57,43,.4)}
.lbtn:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(192,57,43,.55)}
.lback{margin-top:20px;font-size:.82rem;color:var(--txt2)}.lback a{color:var(--gold);text-decoration:none}.lback a:hover{color:var(--gold3)}

/* â”€â”€ LAYOUT â”€â”€ */
#app{display:none;min-height:100vh}#app.on{display:flex}
.sb{width:var(--sw);background:var(--card);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:100;overflow-y:auto;transition:transform .3s}
.sb-logo{padding:25px 24px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
.sb-logo .icon{font-size:1.8rem}
.sb-logo .name{font-family:'Noto Serif',serif;font-size:1.05rem;color:var(--gold3);line-height:1.2}
.sb-logo .sub{font-size:.68rem;color:var(--txt2);letter-spacing:2px;text-transform:uppercase}
.sb-nav{padding:16px 0;flex:1}
.nav-sec{padding:0 12px;margin-bottom:8px}
.nav-sec-lbl{font-size:.65rem;color:var(--txt3);letter-spacing:3px;text-transform:uppercase;padding:8px 12px 6px;display:block}
.nl{display:flex;align-items:center;gap:12px;padding:11px 14px;border-radius:10px;color:var(--txt2);font-size:.9rem;transition:all .2s;cursor:pointer;border:none;background:none;width:100%;text-align:left}
.nl:hover{background:var(--hover);color:var(--txt)}.nl.active{background:rgba(192,57,43,.15);color:var(--gold)}
.nl .ni{font-size:1.1rem;width:22px;text-align:center}
.nl .nb{margin-left:auto;background:var(--red);color:#fff;font-size:.65rem;padding:2px 7px;border-radius:20px;font-weight:700}
.sb-foot{padding:16px 24px;border-top:1px solid var(--border)}
.sb-user{display:flex;align-items:center;gap:10px}
.av{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--red),var(--gold));display:flex;align-items:center;justify-content:center;font-size:1rem}
.un{font-size:.88rem;color:var(--txt);font-weight:600}.ur{font-size:.72rem;color:var(--txt2)}
.logout{margin-left:auto;background:none;border:none;cursor:pointer;font-size:1.1rem;opacity:.5;transition:opacity .2s}.logout:hover{opacity:1}
.mc{margin-left:var(--sw);flex:1;display:flex;flex-direction:column;min-height:100vh}
.topbar{height:var(--hh);background:var(--card);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 30px;position:sticky;top:0;z-index:50;gap:20px}
.topbar-title{font-family:'Noto Serif',serif;font-size:1.15rem;color:var(--txt);flex:1}
.topbar-acts{display:flex;gap:10px;align-items:center}
.badge-admin{background:rgba(192,57,43,.15);border:1px solid var(--border-red);color:var(--red2);padding:5px 14px;border-radius:20px;font-size:.78rem;font-weight:600;letter-spacing:1px}
.ibtn{background:rgba(255,255,255,.04);border:1px solid var(--border);color:var(--txt2);width:36px;height:36px;border-radius:9px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1rem;transition:all .2s;text-decoration:none}
.ibtn:hover{background:var(--hover);color:var(--txt);border-color:rgba(255,255,255,.12)}
.ca{padding:30px;flex:1}
.tab{display:none}.tab.on{display:block}

/* â”€â”€ METRICS â”€â”€ */
.mgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:16px;margin-bottom:24px}
.mc2{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:20px 22px;position:relative;overflow:hidden;transition:all .25s}
.mc2:hover{border-color:rgba(255,255,255,.12);transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,0,0,.3)}
.mc2::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:var(--r) var(--r) 0 0}
.mc2.gold::before{background:linear-gradient(90deg,var(--gold),var(--gold3))}.mc2.red::before{background:linear-gradient(90deg,var(--red),var(--red2))}.mc2.green::before{background:linear-gradient(90deg,#27ae60,var(--green))}.mc2.blue::before{background:linear-gradient(90deg,#2980b9,var(--blue))}.mc2.purple::before{background:linear-gradient(90deg,#8e44ad,#9b59b6)}
.mc2-icon{font-size:1.5rem;margin-bottom:10px;display:block}
.mc2-val{font-family:'Noto Serif',serif;font-size:2rem;font-weight:700;color:var(--txt);line-height:1;margin-bottom:4px}
.mc2-lbl{font-size:.75rem;color:var(--txt2);letter-spacing:1px;text-transform:uppercase}
.mc2-sub{position:absolute;top:18px;right:18px;font-size:.72rem;color:var(--txt3);background:rgba(255,255,255,.04);padding:3px 9px;border-radius:20px;border:1px solid var(--border)}

/* â”€â”€ TABLES â”€â”€ */
.tbl-wrap{background:var(--card);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;margin-bottom:22px}
.tbl-head{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap}
.tbl-ttl{font-family:'Noto Serif',serif;font-size:1rem;color:var(--txt);display:flex;align-items:center;gap:8px}
.tbl-ctrl{display:flex;gap:10px;align-items:center}
.si{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:8px;padding:8px 13px;color:var(--txt);font-size:.82rem;outline:none;transition:border-color .2s;width:180px}
.si:focus{border-color:var(--gold)}.si::placeholder{color:var(--txt3)}
.fsel{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--txt);font-size:.82rem;outline:none;cursor:pointer}
.fsel option{background:var(--card)}
.dt{width:100%;border-collapse:collapse;font-size:.87rem}
.dt th{padding:11px 18px;text-align:left;font-size:.7rem;color:var(--txt3);letter-spacing:2px;text-transform:uppercase;border-bottom:1px solid var(--border);background:rgba(255,255,255,.015);font-weight:600}
.dt td{padding:13px 18px;border-bottom:1px solid var(--border);color:var(--txt2);transition:background .15s}
.dt tr:last-child td{border-bottom:none}.dt tbody tr:hover td{background:var(--hover)}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 11px;border-radius:20px;font-size:.72rem;font-weight:600}
.b-open{background:rgba(46,204,113,.12);color:var(--green);border:1px solid rgba(46,204,113,.2)}
.b-pend{background:rgba(212,160,23,.12);color:var(--gold2);border:1px solid rgba(212,160,23,.2)}
.b-spec{background:rgba(192,57,43,.15);color:var(--red2);border:1px solid rgba(192,57,43,.25)}
.b-norm{background:rgba(136,136,160,.1);color:var(--txt2);border:1px solid var(--border)}

/* â”€â”€ CHARTS â”€â”€ */
.cgrid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:22px}
@media(max-width:900px){.cgrid{grid-template-columns:1fr}}
.ccard{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:22px}
.ccard-ttl{font-family:'Noto Serif',serif;font-size:.95rem;color:var(--txt);margin-bottom:18px}
.brow{margin-bottom:12px}
.blrow{display:flex;justify-content:space-between;margin-bottom:5px;font-size:.79rem}
.blt{color:var(--txt2)}.blv{color:var(--txt);font-weight:600;font-family:'JetBrains Mono',monospace}
.btrack{height:8px;background:rgba(255,255,255,.05);border-radius:4px;overflow:hidden}
.bfill{height:100%;border-radius:4px;transition:width 1.2s cubic-bezier(.22,1,.36,1);min-width:4px}

/* â”€â”€ CONFIG PANEL â”€â”€ */
.cfg-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:22px}
@media(max-width:860px){.cfg-grid{grid-template-columns:1fr}}
.cfg-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:24px}
.cfg-ttl{font-family:'Noto Serif',serif;font-size:1rem;color:var(--txt);margin-bottom:18px;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border);padding-bottom:12px}
.cfg-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.04)}
.cfg-row:last-child{border-bottom:none}
.cfg-lbl{font-size:.88rem;color:var(--txt2)}
.cfg-val{font-family:'JetBrains Mono',monospace;font-size:.88rem;color:var(--gold);background:rgba(212,160,23,.08);padding:4px 11px;border-radius:6px;border:1px solid rgba(212,160,23,.2)}
/* Inputs */
.cfg-input{background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:8px;padding:7px 12px;color:var(--txt);font-family:'JetBrains Mono',monospace;font-size:.9rem;width:90px;outline:none;text-align:center;transition:border-color .2s}
.cfg-input:focus{border-color:var(--gold)}
.cfg-input-lg{width:140px;text-align:left}
/* Ratio sliders */
.ratio-table{width:100%;border-collapse:collapse}
.ratio-table td{padding:8px 6px;vertical-align:middle}
.ratio-table .rlbl{font-family:'JetBrains Mono',monospace;font-size:.82rem;color:var(--txt2);width:40px}
.ratio-table .rslider{flex:1;width:100%}
.ratio-table .rnum{font-family:'JetBrains Mono',monospace;font-size:.82rem;color:var(--gold3);width:28px;text-align:right}
.ratio-table .rpct{font-size:.75rem;color:var(--txt3);width:38px;text-align:right}
input[type=range]{-webkit-appearance:none;width:100%;height:5px;border-radius:3px;background:rgba(255,255,255,.08);outline:none}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--gold);cursor:pointer;border:2px solid var(--gold3)}
input[type=range]::-webkit-slider-thumb:hover{background:var(--gold3)}
/* Toggle switch */
.toggle-row{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.04)}
.toggle-row:last-child{border-bottom:none}
.toggle-lbl{font-size:.88rem;color:var(--txt2);flex:1}
.switch{position:relative;width:42px;height:22px;flex-shrink:0}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;inset:0;background:rgba(255,255,255,.1);border-radius:22px;cursor:pointer;transition:background .3s}
.slider::before{content:'';position:absolute;left:3px;top:3px;width:16px;height:16px;background:#fff;border-radius:50%;transition:transform .3s}
input:checked+.slider{background:var(--red)}
input:checked+.slider::before{transform:translateX(20px)}
/* Action buttons */
.abtn{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;border-radius:9px;border:none;cursor:pointer;font-family:'Noto Sans',sans-serif;font-size:.85rem;font-weight:600;transition:all .2s;width:100%;justify-content:center;margin-top:12px}
.abtn-red{background:rgba(192,57,43,.15);color:var(--red2);border:1px solid rgba(192,57,43,.3)}.abtn-red:hover{background:rgba(192,57,43,.3)}
.abtn-gold{background:rgba(212,160,23,.12);color:var(--gold);border:1px solid rgba(212,160,23,.25)}.abtn-gold:hover{background:rgba(212,160,23,.25)}
.abtn-green{background:rgba(46,204,113,.12);color:var(--green);border:1px solid rgba(46,204,113,.25)}.abtn-green:hover{background:rgba(46,204,113,.25)}
.abtn-blue{background:rgba(52,152,219,.12);color:var(--blue);border:1px solid rgba(52,152,219,.25)}.abtn-blue:hover{background:rgba(52,152,219,.25)}
.save-bar{position:sticky;bottom:0;left:0;right:0;background:rgba(11,12,20,.92);backdrop-filter:blur(12px);border-top:1px solid var(--border-gold);padding:16px 30px;display:none;align-items:center;justify-content:space-between;gap:16px;z-index:200}
.save-bar.show{display:flex}
.save-hint{font-size:.85rem;color:var(--gold2)}
.save-acts{display:flex;gap:10px}
.sbtn{padding:10px 24px;border-radius:9px;border:none;cursor:pointer;font-family:'Noto Sans',sans-serif;font-size:.88rem;font-weight:700;transition:all .2s}
.sbtn-save{background:linear-gradient(135deg,var(--red),var(--red2));color:#fff;box-shadow:0 3px 12px rgba(192,57,43,.4)}.sbtn-save:hover{transform:translateY(-2px)}
.sbtn-disc{background:rgba(255,255,255,.06);color:var(--txt2);border:1px solid var(--border)}.sbtn-disc:hover{background:rgba(255,255,255,.1)}
/* Special env cards */
.sp-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:12px}
.sp-card{background:rgba(192,57,43,.08);border:1px solid rgba(192,57,43,.22);border-radius:10px;padding:14px 16px;transition:all .2s}
.sp-card:hover{border-color:rgba(192,57,43,.45);transform:translateY(-2px)}
.sp-num{font-size:.7rem;color:var(--txt3);margin-bottom:5px}.sp-disp{font-size:.83rem;color:var(--txt2);margin-bottom:3px}
.sp-real{font-family:'Noto Serif',serif;font-size:1.45rem;font-weight:700;color:var(--gold3)}
.sp-st{margin-top:7px}
/* Toast */
.toast{position:fixed;bottom:24px;right:24px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:13px 18px;font-size:.87rem;color:var(--txt);box-shadow:0 8px 30px rgba(0,0,0,.5);z-index:9999;transform:translateX(130%);transition:transform .4s cubic-bezier(.22,1,.36,1);display:flex;align-items:center;gap:10px;min-width:230px}
.toast.show{transform:translateX(0)}.toast.s{border-left:3px solid var(--green)}.toast.e{border-left:3px solid var(--red2)}.toast.i{border-left:3px solid var(--gold)}
@media(max-width:768px){:root{--sw:0px}.sb{transform:translateX(-260px)}.sb.open{transform:translateX(0);width:260px}.mc{margin-left:0}.ca{padding:18px 14px}.cfg-grid,.mgrid{grid-template-columns:1fr}}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:3px}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â• -->
<div id="login-screen">
  <div class="lbox">
    <span class="llogo">ğŸ”</span>
    <h1 class="ltitle">Admin Control Panel</h1>
    <p class="lsub">LÃ¬ XÃ¬ Táº¿t Â· Quáº£n Trá»‹ Há»‡ Thá»‘ng</p>
    <form id="login-form" novalidate>
      <div class="lfield"><label for="lu">TÃªn Ä‘Äƒng nháº­p</label><input type="text" id="lu" placeholder="admin" autocomplete="username" required/></div>
      <div class="lfield"><label for="lp">Máº­t kháº©u</label><input type="password" id="lp" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" required/></div>
      <p class="lerr" id="lerr" role="alert"></p>
      <button type="submit" class="lbtn">ğŸ”“ ÄÄƒng Nháº­p</button>
    </form>
    <p class="lback">â† <a href="/">Quay vá» trang chÆ¡i</a></p>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• APP â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app">
  <!-- SIDEBAR -->
  <aside class="sb" id="sb">
    <div class="sb-logo"><span class="icon">ğŸ§§</span><div><div class="name">LÃ¬ XÃ¬ Admin</div><div class="sub">Control Panel</div></div></div>
    <nav class="sb-nav">
      <div class="nav-sec">
        <span class="nav-sec-lbl">Tá»•ng quan</span>
        <button class="nl active" data-tab="overview"><span class="ni">ğŸ“Š</span><span class="nlbl">Dashboard</span></button>
        <button class="nl" data-tab="envelopes"><span class="ni">ğŸ§§</span><span class="nlbl">Phong bÃ¬</span><span class="nb" id="nb-spec">2</span></button>
      </div>
      <div class="nav-sec">
        <span class="nav-sec-lbl">âš™ï¸ Cáº¥u hÃ¬nh há»‡ thá»‘ng</span>
        <button class="nl" data-tab="config-ratio"><span class="ni">ğŸ²</span><span class="nlbl">Tá»‰ lá»‡ má»‡nh giÃ¡</span></button>
        <button class="nl" data-tab="config-special"><span class="ni">â­</span><span class="nlbl">Má»‡nh giÃ¡ Ä‘áº·c biá»‡t</span></button>
        <button class="nl" data-tab="config-game"><span class="ni">ğŸ®</span><span class="nlbl">CÃ i Ä‘áº·t game</span></button>
      </div>
      <div class="nav-sec">
        <span class="nav-sec-lbl">BÃ¡o cÃ¡o</span>
        <button class="nl" data-tab="analytics"><span class="ni">ğŸ“ˆ</span><span class="nlbl">Thá»‘ng kÃª</span></button>
        <button class="nl" data-tab="log"><span class="ni">ğŸ“‹</span><span class="nlbl">Lá»‹ch sá»­</span></button>
      </div>
    </nav>
    <div class="sb-foot">
      <div class="sb-user">
        <div class="av">A</div>
        <div><div class="un">Admin</div><div class="ur">Quáº£n trá»‹ viÃªn</div></div>
        <button class="logout" id="logout-btn" title="ÄÄƒng xuáº¥t">â»</button>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="mc">
    <div class="topbar">
      <h2 class="topbar-title" id="topbar-title">Dashboard</h2>
      <div class="topbar-acts">
        <span class="badge-admin">ğŸ”’ ADMIN</span>
        <button class="ibtn" id="refresh-btn" title="LÃ m má»›i">â†º</button>
        <button class="ibtn" id="export-btn" title="Xuáº¥t CSV">ğŸ“¥</button>
        <a class="ibtn" href="/" target="_blank" title="Trang ngÆ°á»i chÆ¡i">ğŸ </a>
      </div>
    </div>

    <div class="ca">

      <!-- â”€â”€ TAB: OVERVIEW â”€â”€ -->
      <section class="tab on" id="tab-overview">
        <div class="mgrid">
          <div class="mc2 gold"><span class="mc2-icon">ğŸ§§</span><div class="mc2-val" id="m-total">20</div><div class="mc2-lbl">Tá»•ng sá»‘ Ã´</div><span class="mc2-sub" id="m-total-sub">Cá»‘ Ä‘á»‹nh</span></div>
          <div class="mc2 green"><span class="mc2-icon">âœ…</span><div class="mc2-val" id="m-opened">0</div><div class="mc2-lbl">ÄÃ£ má»Ÿ</div></div>
          <div class="mc2 blue"><span class="mc2-icon">â³</span><div class="mc2-val" id="m-pending">20</div><div class="mc2-lbl">ChÆ°a má»Ÿ</div></div>
          <div class="mc2 red"><span class="mc2-icon">â­</span><div class="mc2-val" id="m-spec">0/2</div><div class="mc2-lbl">Ã” Ä‘áº·c biá»‡t Ä‘Ã£ má»Ÿ</div></div>
          <div class="mc2 purple"><span class="mc2-icon">ğŸ’µ</span><div class="mc2-val" id="m-disp">0k</div><div class="mc2-lbl">Tá»•ng hiá»ƒn thá»‹</div></div>
          <div class="mc2 gold"><span class="mc2-icon">ğŸ’°</span><div class="mc2-val" id="m-real">0k</div><div class="mc2-lbl">Tá»•ng thá»±c táº¿</div></div>
          <div class="mc2 blue"><span class="mc2-icon">ğŸ“Š</span><div class="mc2-val" id="m-pct">0%</div><div class="mc2-lbl">Tiáº¿n Ä‘á»™</div></div>
        </div>
        <div class="cgrid">
          <div class="ccard"><div class="ccard-ttl">ğŸ“Š PhÃ¢n phá»‘i má»‡nh giÃ¡ thá»±c</div><div id="c-dist"></div></div>
          <div class="ccard"><div class="ccard-ttl">ğŸ¯ Tá»‰ lá»‡ má»Ÿ / chÆ°a má»Ÿ</div><div id="c-open"></div></div>
        </div>
        <div class="tbl-wrap">
          <div class="tbl-head"><div class="tbl-ttl">â­ Ã” Äáº·c Biá»‡t</div></div>
          <div style="padding:18px 22px"><div class="sp-grid" id="sp-cards"></div></div>
        </div>
      </section>

      <!-- â”€â”€ TAB: ENVELOPES â”€â”€ -->
      <section class="tab" id="tab-envelopes">
        <div class="tbl-wrap">
          <div class="tbl-head">
            <div class="tbl-ttl">ğŸ§§ Danh sÃ¡ch phong bÃ¬</div>
            <div class="tbl-ctrl">
              <input type="search" class="si" id="env-search" placeholder="TÃ¬m..."/>
              <select class="fsel" id="env-filter">
                <option value="all">Táº¥t cáº£</option><option value="opened">ÄÃ£ má»Ÿ</option>
                <option value="pending">ChÆ°a má»Ÿ</option><option value="special">Äáº·c biá»‡t</option>
              </select>
            </div>
          </div>
          <table class="dt"><thead><tr><th>ID</th><th>Loáº¡i</th><th>Hiá»ƒn thá»‹</th><th>Thá»±c táº¿</th><th>Tráº¡ng thÃ¡i</th><th>Thá»i gian</th><th>Thao tÃ¡c</th></tr></thead>
          <tbody id="env-tbody"></tbody></table>
        </div>
      </section>

      <!-- â”€â”€ TAB: CONFIG RATIO â”€â”€ -->
      <section class="tab" id="tab-config-ratio">
        <div class="cfg-card" style="margin-bottom:18px">
          <div class="cfg-ttl">ğŸ² Tá»‰ lá»‡ phÃ¢n phá»‘i má»‡nh giÃ¡ hiá»ƒn thá»‹ (1kâ€“20k)</div>
          <p style="font-size:.83rem;color:var(--txt2);margin-bottom:18px;line-height:1.7">KÃ©o slider Ä‘á»ƒ Ä‘iá»u chá»‰nh sá»‘ lÆ°á»£ng tá»«ng má»‡nh giÃ¡ trong tá»•ng sá»‘ Ã´. Tá»•ng sá»‘ Ã´ = tá»•ng táº¥t cáº£ sá»‘ lÆ°á»£ng.</p>
          <table class="ratio-table" id="ratio-table">
            <!-- Rendered by JS -->
          </table>
          <div style="margin-top:16px;padding:12px 16px;background:rgba(212,160,23,.06);border:1px solid rgba(212,160,23,.2);border-radius:10px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
            <span style="font-size:.85rem;color:var(--txt2)">Tá»•ng sá»‘ Ã´ hiá»‡n táº¡i:</span>
            <span style="font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:700;color:var(--gold3)" id="ratio-total-display">20</span>
          </div>
        </div>
        <div class="cfg-card" style="margin-bottom:18px">
          <div class="cfg-ttl">ğŸ“ Xem trÆ°á»›c phÃ¢n phá»‘i</div>
          <div id="ratio-preview"></div>
        </div>
        <button class="abtn abtn-green" id="save-ratio-btn">ğŸ’¾ LÆ°u tá»‰ lá»‡ má»‡nh giÃ¡</button>
      </section>

      <!-- â”€â”€ TAB: CONFIG SPECIAL â”€â”€ -->
      <section class="tab" id="tab-config-special">
        <div class="cfg-card" style="margin-bottom:18px">
          <div class="cfg-ttl">â­ Má»‡nh giÃ¡ Ä‘áº·c biá»‡t (áº©n vá»›i ngÆ°á»i chÆ¡i)</div>
          <p style="font-size:.83rem;color:var(--txt2);margin-bottom:20px;line-height:1.7">NgÆ°á»i chÆ¡i tháº¥y má»‡nh giÃ¡ bÃ¬nh thÆ°á»ng, nhÆ°ng khi má»Ÿ Ã´ Ä‘áº·c biá»‡t sáº½ Ä‘Æ°á»£c gá»£i Ã½ vÃ o Admin Ä‘á»ƒ nháº­n thÆ°á»Ÿng giÃ¡ trá»‹ cao hÆ¡n.</p>
          <div id="special-inputs"><!-- Rendered by JS --></div>
          <button class="abtn abtn-gold" id="add-special-btn">â• ThÃªm má»‡nh giÃ¡ Ä‘áº·c biá»‡t</button>
        </div>
        <div class="cfg-card" style="margin-bottom:18px">
          <div class="cfg-ttl">ğŸ”¢ Sá»‘ Ã´ Ä‘áº·c biá»‡t</div>
          <div class="cfg-row">
            <span class="cfg-lbl">Sá»‘ lÆ°á»£ng Ã´ Ä‘áº·c biá»‡t trong game</span>
            <input type="number" class="cfg-input" id="special-count" min="1" max="10" value="2"/>
          </div>
          <p style="font-size:.78rem;color:var(--txt3);margin-top:10px">LÆ°u Ã½: Sá»‘ Ã´ Ä‘áº·c biá»‡t khÃ´ng nÃªn vÆ°á»£t quÃ¡ sá»‘ má»‡nh giÃ¡ Ä‘áº·c biá»‡t Ä‘Ã£ nháº­p.</p>
        </div>
        <button class="abtn abtn-green" id="save-special-btn">ğŸ’¾ LÆ°u má»‡nh giÃ¡ Ä‘áº·c biá»‡t</button>
      </section>

      <!-- â”€â”€ TAB: CONFIG GAME â”€â”€ -->
      <section class="tab" id="tab-config-game">
        <div class="cfg-grid">
          <div class="cfg-card">
            <div class="cfg-ttl">ğŸ® ThÃ´ng tin game</div>
            <div class="cfg-row"><span class="cfg-lbl">TiÃªu Ä‘á» trang</span><input type="text" class="cfg-input cfg-input-lg" id="g-title" value="LÃ¬ XÃ¬ Táº¿t 2025"/></div>
            <div class="cfg-row"><span class="cfg-lbl">Phá»¥ Ä‘á»</span><input type="text" class="cfg-input cfg-input-lg" id="g-sub" value="ChÃºc má»«ng nÄƒm má»›i Â· Váº¡n sá»± nhÆ° Ã½"/></div>
            <div class="cfg-row"><span class="cfg-lbl">Sá»‘ confetti má»—i láº§n má»Ÿ</span><input type="number" class="cfg-input" id="g-confetti" min="20" max="300" value="80"/></div>
          </div>
          <div class="cfg-card">
            <div class="cfg-ttl">ğŸ” TÃ i khoáº£n Admin</div>
            <div class="cfg-row"><span class="cfg-lbl">TÃªn Ä‘Äƒng nháº­p</span><input type="text" class="cfg-input cfg-input-lg" id="g-user" value="admin"/></div>
            <div class="cfg-row"><span class="cfg-lbl">Máº­t kháº©u má»›i</span><input type="password" class="cfg-input cfg-input-lg" id="g-pass" placeholder="Äá»ƒ trá»‘ng = giá»¯ nguyÃªn"/></div>
            <p style="font-size:.75rem;color:var(--txt3);margin-top:10px">âš  Thay Ä‘á»•i máº­t kháº©u sáº½ cÃ³ hiá»‡u lá»±c ngay láº§n sau Ä‘Äƒng nháº­p.</p>
          </div>
          <div class="cfg-card">
            <div class="cfg-ttl">ğŸ› TÃ­nh nÄƒng</div>
            <div class="toggle-row"><span class="toggle-lbl">Hiá»‡u á»©ng confetti</span><label class="switch"><input type="checkbox" id="f-confetti" checked/><span class="slider"></span></label></div>
            <div class="toggle-row"><span class="toggle-lbl">Hoa rÆ¡i ná»n</span><label class="switch"><input type="checkbox" id="f-petals" checked/><span class="slider"></span></label></div>
            <div class="toggle-row"><span class="toggle-lbl">Gá»£i Ã½ Admin khi má»Ÿ Ã´ Ä‘áº·c biá»‡t</span><label class="switch"><input type="checkbox" id="f-hint" checked/><span class="slider"></span></label></div>
          </div>
          <div class="cfg-card">
            <div class="cfg-ttl">ğŸ›  Thao tÃ¡c há»‡ thá»‘ng</div>
            <button class="abtn abtn-gold" onclick="applyGameConfig()">ğŸ’¾ LÆ°u cÃ i Ä‘áº·t game</button>
            <button class="abtn abtn-red" id="reset-game-btn">ğŸ”„ Äáº·t láº¡i toÃ n bá»™ game</button>
            <button class="abtn abtn-blue" onclick="document.getElementById('export-btn').click()">ğŸ“¥ Xuáº¥t dá»¯ liá»‡u CSV</button>
            <button class="abtn abtn-green" onclick="window.open('/','_blank')">ğŸ§§ Xem trang ngÆ°á»i chÆ¡i</button>
          </div>
        </div>
      </section>

      <!-- â”€â”€ TAB: ANALYTICS â”€â”€ -->
      <section class="tab" id="tab-analytics">
        <div class="cgrid">
          <div class="ccard"><div class="ccard-ttl">ğŸ“Š PhÃ¢n phá»‘i má»‡nh giÃ¡ thá»±c</div><div id="c-dist2"></div></div>
          <div class="ccard"><div class="ccard-ttl">ğŸ¯ Tá»‰ lá»‡ má»Ÿ</div><div id="c-open2"></div></div>
        </div>
        <div class="tbl-wrap">
          <div class="tbl-head"><div class="tbl-ttl">ğŸ“Š Thá»‘ng kÃª theo má»‡nh giÃ¡</div></div>
          <table class="dt"><thead><tr><th>Má»‡nh giÃ¡</th><th>Sá»‘ Ã´</th><th>ÄÃ£ má»Ÿ</th><th>Tá»‰ lá»‡ má»Ÿ</th><th>Tá»•ng tiá»n</th></tr></thead>
          <tbody id="stat-tbody"></tbody></table>
        </div>
      </section>

      <!-- â”€â”€ TAB: LOG â”€â”€ -->
      <section class="tab" id="tab-log">
        <div class="tbl-wrap">
          <div class="tbl-head">
            <div class="tbl-ttl">ğŸ“‹ Lá»‹ch sá»­ bá»‘c (má»›i nháº¥t trÆ°á»›c)</div>
            <button class="ibtn" onclick="renderLog()" title="LÃ m má»›i">â†º</button>
          </div>
          <table class="dt"><thead><tr><th>STT</th><th>Ã” #</th><th>Hiá»ƒn thá»‹</th><th>Thá»±c táº¿</th><th>Loáº¡i</th><th>Thá»i gian</th></tr></thead>
          <tbody id="log-tbody"></tbody>
        </div>
      </section>

    </div><!-- /ca -->

    <!-- SAVE BAR -->
    <div class="save-bar" id="save-bar">
      <span class="save-hint">âš¡ CÃ³ thay Ä‘á»•i chÆ°a lÆ°u â€” Game sáº½ dÃ¹ng cáº¥u hÃ¬nh má»›i sau khi ChÆ¡i Láº¡i.</span>
      <div class="save-acts">
        <button class="sbtn sbtn-disc" id="discard-btn">Há»§y</button>
        <button class="sbtn sbtn-save" id="save-btn">ğŸ’¾ LÆ°u & Ãp dá»¥ng</button>
      </div>
    </div>
  </main>
</div>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
'use strict';
// â”€â”€ CONSTANTS â”€â”€
const STORE_CONFIG='lixi_config';
const STORE_GAME='lixi_game_data';
const STORE_ADMIN='lixi_admin_auth';
const DEF={totalEnvelopes:20,title:'LÃ¬ XÃ¬ Táº¿t 2025',subtitle:'ChÃºc má»«ng nÄƒm má»›i Â· Váº¡n sá»± nhÆ° Ã½',distribution:{1:2,2:2,3:2,5:3,10:4,15:2,20:5},specialValues:[50,100],specialCount:2,confettiCount:80,adminUser:'admin',adminPass:'lixÃ¬2025',features:{confetti:true,petals:true,hint:true}};

// â”€â”€ ADMIN CREDS (stored in sessionStorage, default from config) â”€â”€
let ADMIN_USER='admin',ADMIN_PASS='lixÃ¬2025';
function loadAdminCreds(){const c=loadCfg();ADMIN_USER=c.adminUser||DEF.adminUser;ADMIN_PASS=c.adminPass||DEF.adminPass}

// â”€â”€ CONFIG â”€â”€
function loadCfg(){try{const r=localStorage.getItem(STORE_CONFIG);if(r)return Object.assign({},DEF,JSON.parse(r))}catch{}return Object.assign({},DEF)}
function saveCfg(c){localStorage.setItem(STORE_CONFIG,JSON.stringify(c))}

// â”€â”€ GAME DATA â”€â”€
function loadGame(){try{const r=localStorage.getItem(STORE_GAME);if(r)return JSON.parse(r)}catch{}return[]}
function saveGame(d){localStorage.setItem(STORE_GAME,JSON.stringify(d))}

// â”€â”€ SESSION â”€â”€
function checkSess(){return sessionStorage.getItem(STORE_ADMIN)==='1'}
function saveSess(){sessionStorage.setItem(STORE_ADMIN,'1')}
function clearSess(){sessionStorage.removeItem(STORE_ADMIN)}

// â”€â”€ PENDING CONFIG (before save) â”€â”€
let pendingCfg=null;
function getPending(){return pendingCfg||loadCfg()}
function markDirty(){pendingCfg=pendingCfg||Object.assign({},loadCfg());document.getElementById('save-bar').classList.add('show')}

// â”€â”€ DOM â”€â”€
const loginScreen=document.getElementById('login-screen');
const appEl=document.getElementById('app');
const lerrEl=document.getElementById('lerr');

// â”€â”€ BOOT â”€â”€
document.addEventListener('DOMContentLoaded',()=>{
  loadAdminCreds();
  if(checkSess())showApp();
  document.getElementById('login-form').addEventListener('submit',e=>{
    e.preventDefault();
    const u=document.getElementById('lu').value.trim();
    const p=document.getElementById('lp').value;
    loadAdminCreds();
    if(u===ADMIN_USER&&p===ADMIN_PASS){lerrEl.textContent='';loginScreen.classList.add('hidden');saveSess();showApp()}
    else{lerrEl.textContent='âš  Sai tÃªn Ä‘Äƒng nháº­p hoáº·c máº­t kháº©u!';lerrEl.classList.remove('shake');void lerrEl.offsetWidth;lerrEl.classList.add('shake');document.getElementById('lp').value='';document.getElementById('lp').focus()}
  });
});

let gameData=[];
function showApp(){
  appEl.classList.add('on');
  gameData=loadGame();
  if(!gameData.length)gameData=genDemoData();
  populateConfigForms();
  renderAll();
  setupNav();
  setupControls();
}

// â”€â”€ DEMO DATA â”€â”€
function genDemoData(){
  const cfg=loadCfg();let pool=[];
  Object.entries(cfg.distribution).forEach(([v,q])=>{for(let i=0;i<q;i++)pool.push(Number(v))});
  const total=cfg.totalEnvelopes;
  while(pool.length<total)pool.push(pool[Math.floor(Math.random()*pool.length)]);
  pool=shuffle(pool.slice(0,total));
  const sc=Math.min(cfg.specialCount,total);
  const sl=shuffle(Array.from({length:total},(_,i)=>i)).slice(0,sc);
  const sv=shuffle([...cfg.specialValues]).slice(0,sc);
  const data=Array.from({length:total},(_,i)=>{const isSp=sl.includes(i);const si=sl.indexOf(i);const opened=Math.random()>.5;return{id:i+1,displayValue:pool[i],realValue:isSp?sv[si]:pool[i],isSpecial:isSp,opened,openedAt:opened?new Date(Date.now()-Math.random()*3.6e6).toISOString():null}});
  saveGame(data);return data;
}
function shuffle(a){const b=[...a];for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]]}return b}

// â”€â”€ RENDER ALL â”€â”€
function renderAll(){
  renderMetrics();renderEnvTable();renderSpecialCards();renderCharts('c-dist','c-open');renderStatTable();
}

// â”€â”€ METRICS â”€â”€
function renderMetrics(){
  const cfg=loadCfg();
  const tot=gameData.length||cfg.totalEnvelopes;
  const op=gameData.filter(e=>e.opened).length;
  const sp=gameData.filter(e=>e.isSpecial);
  const spOp=sp.filter(e=>e.opened).length;
  const totD=gameData.filter(e=>e.opened).reduce((s,e)=>s+e.displayValue,0);
  const totR=gameData.filter(e=>e.opened).reduce((s,e)=>s+e.realValue,0);
  const s=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v};
  s('m-total',tot);s('m-opened',op);s('m-pending',tot-op);s('m-spec',spOp+'/'+sp.length);
  s('m-disp',totD+'k');s('m-real',totR+'k');s('m-pct',Math.round(op/Math.max(tot,1)*100)+'%');
  s('nb-spec',sp.length);
}

// â”€â”€ ENVELOPE TABLE â”€â”€
function renderEnvTable(fv='all',sv=''){
  const tb=document.getElementById('env-tbody');tb.innerHTML='';
  let d=[...gameData];
  if(fv==='opened')d=d.filter(e=>e.opened);
  if(fv==='pending')d=d.filter(e=>!e.opened);
  if(fv==='special')d=d.filter(e=>e.isSpecial);
  if(sv){const s=sv.toLowerCase();d=d.filter(e=>String(e.id).includes(s)||String(e.displayValue).includes(s)||String(e.realValue).includes(s))}
  d.forEach(env=>{const tr=document.createElement('tr');
  tr.innerHTML=`<td style="font-family:'JetBrains Mono',monospace;color:var(--txt)">#${String(env.id).padStart(2,'0')}</td><td><span class="badge ${env.isSpecial?'b-spec':'b-norm'}">${env.isSpecial?'ğŸ”¥ Äáº·c biá»‡t':'ğŸ“¦ ThÆ°á»ng'}</span></td><td style="font-family:'JetBrains Mono',monospace">${env.displayValue}k</td><td style="font-family:'JetBrains Mono',monospace;color:${env.isSpecial?'var(--gold3)':'var(--txt2)'}">${env.realValue}k${env.isSpecial?' â­':''}</td><td><span class="badge ${env.opened?'b-open':'b-pend'}">${env.opened?'âœ“ ÄÃ£ má»Ÿ':'â—‹ Chá»'}</span></td><td style="font-size:.78rem;color:var(--txt3)">${env.openedAt?new Date(env.openedAt).toLocaleString('vi-VN'):'â€”'}</td><td><button class="ibtn" onclick="toggleEnv(${env.id-1})" title="${env.opened?'Äáº·t láº¡i':'ÄÃ¡nh dáº¥u'}">${env.opened?'â†º':'âœ“'}</button></td>`;
  tb.appendChild(tr)});
  if(!d.length)tb.innerHTML='<tr><td colspan="7" style="text-align:center;color:var(--txt3);padding:28px">KhÃ´ng cÃ³ dá»¯ liá»‡u</td></tr>';
}
window.toggleEnv=function(i){
  if(i<0||i>=gameData.length)return;
  gameData[i].opened=!gameData[i].opened;gameData[i].openedAt=gameData[i].opened?new Date().toISOString():null;
  saveGame(gameData);renderAll();toast(`${gameData[i].opened?'âœ“ ÄÃ£ má»Ÿ':'â†º Äáº·t láº¡i'} Ã´ #${String(gameData[i].id).padStart(2,'0')}`,'s');
};

// â”€â”€ SPECIAL CARDS â”€â”€
function renderSpecialCards(){
  const c=document.getElementById('sp-cards');c.innerHTML='';
  gameData.filter(e=>e.isSpecial).forEach(env=>{
    const card=document.createElement('div');card.className='sp-card';
    card.innerHTML=`<div class="sp-num">Ã” #${String(env.id).padStart(2,'0')}</div><div class="sp-disp">Hiá»ƒn thá»‹: ${env.displayValue}k</div><div class="sp-real">${env.realValue}k ğŸ†</div><div class="sp-st"><span class="badge ${env.opened?'b-open':'b-pend'}">${env.opened?'âœ“ ÄÃ£ Ä‘Æ°á»£c bá»‘c':'â—‹ ChÆ°a má»Ÿ'}</span></div>`;
    c.appendChild(card);
  });
  if(!gameData.filter(e=>e.isSpecial).length)c.innerHTML='<p style="color:var(--txt3);font-size:.88rem">ChÆ°a cÃ³ dá»¯ liá»‡u game. NgÆ°á»i chÆ¡i cáº§n báº¯t Ä‘áº§u game trÆ°á»›c.</p>';
}

// â”€â”€ CHARTS â”€â”€
const DIST_COLORS={1:'#8888a0',2:'#8888a0',3:'#8888a0',5:'#3498db',10:'#3498db',15:'#9b59b6',20:'#e67e22',50:'#e74c3c',100:'#ffd700'};
function renderCharts(dc,oc){
  const dist={};gameData.forEach(e=>{dist[e.realValue]=(dist[e.realValue]||0)+1});
  const dEl=document.getElementById(dc);dEl.innerHTML='';
  const mx=Math.max(...Object.values(dist),1);
  Object.entries(dist).sort((a,b)=>Number(a[0])-Number(b[0])).forEach(([v,c])=>{
    const row=document.createElement('div');row.className='brow';
    row.innerHTML=`<div class="blrow"><span class="blt">${v}k</span><span class="blv">${c} Ã´ (${Math.round(c/gameData.length*100)}%)</span></div><div class="btrack"><div class="bfill" style="width:0%;background:${DIST_COLORS[v]||'#8888a0'}" data-w="${c/mx*100}"></div></div>`;
    dEl.appendChild(row);
  });
  const op=gameData.filter(e=>e.opened).length;const pend=gameData.length-op;
  const oEl=document.getElementById(oc);oEl.innerHTML=`<div class="brow"><div class="blrow"><span class="blt">ÄÃ£ má»Ÿ</span><span class="blv">${op} Ã´ (${Math.round(op/Math.max(gameData.length,1)*100)}%)</span></div><div class="btrack"><div class="bfill" style="width:0%;background:linear-gradient(90deg,#27ae60,#2ecc71)" data-w="${op/Math.max(gameData.length,1)*100}"></div></div></div><div class="brow"><div class="blrow"><span class="blt">ChÆ°a má»Ÿ</span><span class="blv">${pend} Ã´ (${Math.round(pend/Math.max(gameData.length,1)*100)}%)</span></div><div class="btrack"><div class="bfill" style="width:0%;background:linear-gradient(90deg,#d4a017,#f1c40f)" data-w="${pend/Math.max(gameData.length,1)*100}"></div></div></div>`;
  setTimeout(()=>document.querySelectorAll('.bfill').forEach(el=>{el.style.width=el.dataset.w+'%'}),150);
}

// â”€â”€ STAT TABLE â”€â”€
function renderStatTable(){
  const tb=document.getElementById('stat-tbody');tb.innerHTML='';
  const vals={};gameData.forEach(e=>{if(!vals[e.realValue])vals[e.realValue]={total:0,opened:0};vals[e.realValue].total++;if(e.opened)vals[e.realValue].opened++});
  Object.entries(vals).sort((a,b)=>Number(a[0])-Number(b[0])).forEach(([v,d])=>{
    const tr=document.createElement('tr');const pct=Math.round(d.opened/d.total*100);
    tr.innerHTML=`<td style="font-family:'JetBrains Mono',monospace;color:var(--gold3)">${v}k</td><td>${d.total}</td><td>${d.opened}</td><td><div style="display:flex;align-items:center;gap:8px"><div style="width:80px;height:6px;background:rgba(255,255,255,.05);border-radius:3px;overflow:hidden"><div style="width:${pct}%;height:100%;background:var(--green);border-radius:3px"></div></div><span style="font-size:.78rem">${pct}%</span></div></td><td style="font-family:'JetBrains Mono',monospace">${v*d.opened}k</td>`;
    tb.appendChild(tr);
  });
}

// â”€â”€ LOG â”€â”€
function renderLog(){
  const tb=document.getElementById('log-tbody');tb.innerHTML='';
  const opened=gameData.filter(e=>e.opened&&e.openedAt).sort((a,b)=>new Date(b.openedAt)-new Date(a.openedAt));
  opened.forEach((e,i)=>{const tr=document.createElement('tr');tr.innerHTML=`<td style="color:var(--txt3)">${i+1}</td><td style="font-family:'JetBrains Mono',monospace;color:var(--txt)">#${String(e.id).padStart(2,'0')}</td><td style="font-family:'JetBrains Mono',monospace">${e.displayValue}k</td><td style="font-family:'JetBrains Mono',monospace;color:${e.isSpecial?'var(--gold3)':'var(--txt2)'}">${e.realValue}k${e.isSpecial?' â­':''}</td><td><span class="badge ${e.isSpecial?'b-spec':'b-norm'}">${e.isSpecial?'ğŸ”¥ Äáº·c biá»‡t':'ğŸ“¦ ThÆ°á»ng'}</span></td><td style="font-size:.78rem;color:var(--txt3)">${new Date(e.openedAt).toLocaleString('vi-VN')}</td>`;tb.appendChild(tr)});
  if(!opened.length)tb.innerHTML='<tr><td colspan="6" style="text-align:center;color:var(--txt3);padding:28px">ChÆ°a cÃ³ Ã´ nÃ o Ä‘Æ°á»£c má»Ÿ</td></tr>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG FORMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RATIO_VALUES=[1,2,3,5,10,15,20];
let ratioState={};

function populateConfigForms(){
  const cfg=loadCfg();
  // Ratio
  RATIO_VALUES.forEach(v=>{ratioState[v]=cfg.distribution[v]||0});
  renderRatioTable();
  // Special values
  renderSpecialInputs(cfg.specialValues||[50,100]);
  document.getElementById('special-count').value=cfg.specialCount||2;
  // Game settings
  document.getElementById('g-title').value=cfg.title||DEF.title;
  document.getElementById('g-sub').value=cfg.subtitle||DEF.subtitle;
  document.getElementById('g-confetti').value=cfg.confettiCount||80;
  document.getElementById('g-user').value=cfg.adminUser||'admin';
  // Features
  const f=cfg.features||DEF.features;
  document.getElementById('f-confetti').checked=f.confetti!==false;
  document.getElementById('f-petals').checked=f.petals!==false;
  document.getElementById('f-hint').checked=f.hint!==false;
}

function renderRatioTable(){
  const tbl=document.getElementById('ratio-table');tbl.innerHTML='';
  let total=0;Object.values(ratioState).forEach(v=>total+=v);
  RATIO_VALUES.forEach(val=>{
    const qty=ratioState[val]||0;total=total||1;
    const pct=Math.round(qty/total*100);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="rlbl">${val}k</td><td style="padding:8px"><input type="range" class="rslider" min="0" max="20" value="${qty}" data-val="${val}" oninput="updateRatio(${val},this.value)"/></td><td class="rnum" id="rnum-${val}">${qty}</td><td class="rpct" id="rpct-${val}">${pct}%</td>`;
    tbl.appendChild(tr);
  });
  updateRatioTotal();
  renderRatioPreview();
}

function updateRatio(val,qty){
  ratioState[val]=parseInt(qty)||0;
  const n=document.getElementById('rnum-'+val);if(n)n.textContent=qty;
  updateRatioTotal();renderRatioPreview();
  markDirty();
}

function updateRatioTotal(){
  let tot=0;Object.values(ratioState).forEach(v=>tot+=v);
  const el=document.getElementById('ratio-total-display');if(el)el.textContent=tot;
  // Update pct
  RATIO_VALUES.forEach(val=>{
    const p=document.getElementById('rpct-'+val);if(p)p.textContent=(tot>0?Math.round((ratioState[val]||0)/tot*100):0)+'%';
  });
}

function renderRatioPreview(){
  const c=document.getElementById('ratio-preview');c.innerHTML='';
  let tot=0;Object.values(ratioState).forEach(v=>tot+=v);
  if(tot===0){c.innerHTML='<p style="color:var(--txt3);font-size:.85rem">Táº¥t cáº£ Ä‘á»u báº±ng 0</p>';return}
  RATIO_VALUES.forEach(val=>{
    const qty=ratioState[val]||0;if(qty===0)return;
    const pct=qty/tot*100;
    const row=document.createElement('div');row.className='brow';
    row.innerHTML=`<div class="blrow"><span class="blt">${val}k</span><span class="blv">${qty} Ã´ Â· ${Math.round(pct)}%</span></div><div class="btrack"><div style="width:${pct}%;height:8px;border-radius:4px;background:${DIST_COLORS[val]||'#8888a0'}"></div></div>`;
    c.appendChild(row);
  });
}

function saveRatioConfig(){
  const cfg=loadCfg();let tot=0;Object.values(ratioState).forEach(v=>tot+=v);
  if(tot===0){toast('âš  Tá»•ng sá»‘ Ã´ pháº£i > 0','e');return}
  cfg.distribution={...ratioState};cfg.totalEnvelopes=tot;saveCfg(cfg);
  toast('âœ“ ÄÃ£ lÆ°u tá»‰ lá»‡ má»‡nh giÃ¡! Nháº¥n "ChÆ¡i Láº¡i" Ä‘á»ƒ Ã¡p dá»¥ng.','s');
  hideSaveBar();
}

// Special inputs
let specialList=[50,100];
function renderSpecialInputs(vals){
  specialList=[...vals];
  const c=document.getElementById('special-inputs');c.innerHTML='';
  specialList.forEach((v,i)=>{
    const row=document.createElement('div');row.className='cfg-row';
    row.innerHTML=`<span class="cfg-lbl">Má»‡nh giÃ¡ Ä‘áº·c biá»‡t #${i+1}</span><div style="display:flex;gap:8px;align-items:center"><input type="number" class="cfg-input" value="${v}" min="1" max="9999" onchange="updateSpecial(${i},this.value)"/><button class="ibtn" style="color:var(--red2)" onclick="removeSpecial(${i})" title="XÃ³a">âœ•</button></div>`;
    c.appendChild(row);
  });
}
function updateSpecial(i,v){specialList[i]=parseInt(v)||0;markDirty()}
function removeSpecial(i){specialList.splice(i,1);renderSpecialInputs(specialList);markDirty()}
document.getElementById('add-special-btn')?.addEventListener('click',()=>{specialList.push(50);renderSpecialInputs(specialList);markDirty()});
function saveSpecialConfig(){
  const cfg=loadCfg();
  cfg.specialValues=specialList.filter(v=>v>0);
  cfg.specialCount=parseInt(document.getElementById('special-count').value)||2;
  saveCfg(cfg);toast('âœ“ ÄÃ£ lÆ°u má»‡nh giÃ¡ Ä‘áº·c biá»‡t! Nháº¥n "ChÆ¡i Láº¡i" Ä‘á»ƒ Ã¡p dá»¥ng.','s');hideSaveBar();
}

// Game config
function applyGameConfig(){
  const cfg=loadCfg();
  cfg.title=document.getElementById('g-title').value||DEF.title;
  cfg.subtitle=document.getElementById('g-sub').value||DEF.subtitle;
  cfg.confettiCount=parseInt(document.getElementById('g-confetti').value)||80;
  cfg.adminUser=document.getElementById('g-user').value||'admin';
  const np=document.getElementById('g-pass').value;if(np)cfg.adminPass=np;
  cfg.features={confetti:document.getElementById('f-confetti').checked,petals:document.getElementById('f-petals').checked,hint:document.getElementById('f-hint').checked};
  saveCfg(cfg);toast('âœ“ ÄÃ£ lÆ°u cÃ i Ä‘áº·t game!','s');hideSaveBar();
}

// â”€â”€ SAVE BAR â”€â”€
function hideSaveBar(){document.getElementById('save-bar').classList.remove('show');pendingCfg=null}
document.getElementById('save-btn')?.addEventListener('click',()=>{
  const active=document.querySelector('.tab.on');
  if(!active)return;
  if(active.id==='tab-config-ratio')saveRatioConfig();
  else if(active.id==='tab-config-special')saveSpecialConfig();
  else{applyGameConfig()}
});
document.getElementById('discard-btn')?.addEventListener('click',()=>{hideSaveBar();populateConfigForms();renderRatioTable()});

// â”€â”€ NAVIGATION â”€â”€
function setupNav(){
  document.querySelectorAll('[data-tab]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('[data-tab]').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));
      const t=document.getElementById('tab-'+btn.dataset.tab);if(t)t.classList.add('on');
      document.getElementById('topbar-title').textContent=btn.querySelector('.nlbl')?.textContent||'Dashboard';
      if(btn.dataset.tab==='analytics'){renderCharts('c-dist2','c-open2');renderStatTable()}
      if(btn.dataset.tab==='log')renderLog();
    });
  });
}

// â”€â”€ CONTROLS â”€â”€
function setupControls(){
  document.getElementById('env-search')?.addEventListener('input',function(){renderEnvTable(document.getElementById('env-filter').value,this.value)});
  document.getElementById('env-filter')?.addEventListener('change',function(){renderEnvTable(this.value,document.getElementById('env-search').value)});
  document.getElementById('logout-btn')?.addEventListener('click',()=>{clearSess();window.location.reload()});
  document.getElementById('refresh-btn')?.addEventListener('click',()=>{gameData=loadGame();if(!gameData.length)gameData=genDemoData();renderAll();toast('â†º ÄÃ£ lÃ m má»›i','i')});
  document.getElementById('export-btn')?.addEventListener('click',exportCSV);
  document.getElementById('reset-game-btn')?.addEventListener('click',()=>{if(confirm('Äáº·t láº¡i toÃ n bá»™ game? Táº¥t cáº£ Ã´ vá» tráº¡ng thÃ¡i chÆ°a má»Ÿ.')){gameData.forEach(e=>{e.opened=false;e.openedAt=null});saveGame(gameData);renderAll();toast('âœ“ ÄÃ£ Ä‘áº·t láº¡i game','s')}});
  document.getElementById('save-ratio-btn')?.addEventListener('click',saveRatioConfig);
  document.getElementById('save-special-btn')?.addEventListener('click',saveSpecialConfig);
  // Watch config inputs for dirty
  ['g-title','g-sub','g-confetti','g-user','g-pass','f-confetti','f-petals','f-hint'].forEach(id=>{
    const el=document.getElementById(id);if(el)el.addEventListener('change',markDirty);
  });
}

// â”€â”€ EXPORT â”€â”€
function exportCSV(){
  const h=['ID','Loáº¡i','Hiá»ƒn thá»‹','Thá»±c táº¿','Tráº¡ng thÃ¡i','Thá»i gian'];
  const rows=gameData.map(e=>['#'+String(e.id).padStart(2,'0'),e.isSpecial?'Äáº·c biá»‡t':'ThÆ°á»ng',e.displayValue+'k',e.realValue+'k',e.opened?'ÄÃ£ má»Ÿ':'ChÆ°a má»Ÿ',e.openedAt?new Date(e.openedAt).toLocaleString('vi-VN'):'â€”']);
  const csv=[h,...rows].map(r=>r.join(',')).join('\n');
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8'}));a.download=`lixi-${new Date().toLocaleDateString('vi-VN').replaceAll('/','-')}.csv`;a.click();
  toast('ğŸ“¥ ÄÃ£ xuáº¥t CSV','s');
}

// â”€â”€ TOAST â”€â”€
const toastEl=document.getElementById('toast');let toastT;
function toast(msg,t='i'){if(!toastEl)return;toastEl.textContent=msg;toastEl.className='toast '+t+' show';clearTimeout(toastT);toastT=setTimeout(()=>toastEl.classList.remove('show'),3200)}
</script>
</body>
</html>
